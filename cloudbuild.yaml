steps:
# step 0 Upload to Cloud Storage.
- id: "Download"
  name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args: ['gsutil', 'cp', 'gs://cache-psnext-v1-$BRANCH_NAME/*.tar.gz', '.']
# step 1  build
- id: "Build"
  name: 'gcr.io/$PROJECT_ID/psnextv1-builder'
  entrypoint: bash
  args:
    - -c
    - |
      pwd
      tar xzf nm.tar.gz
      tar xzf dist.tar.gz
      # save the commit info & build date
      NOW=$(date +"%Y-%m-%d %T")
      echo "{\"branch\":\"$BRANCH_NAME\", \"commit\":\"$COMMIT_SHA\", \"repo\":\"$REPO_NAME\", \"buildtime\":\"$$NOW\", \"buildid\":\"$BUILD_ID\"}" > _buildinfo.js
      cat _buildinfo.js
      node --version
      docker --version
      npm i --quiet --no-progress
      # npm run nx -- run-many --target=build --all
      npm run nx -- affected:build --base=origin/$BRANCH_NAME~1 --head=origin/$BRANCH_NAME # rerun what is affected by the last commit in $BRANCH_NAME
# step 2 cache
- id: "Cache"
  name: 'gcr.io/$PROJECT_ID/psnextv1-builder'
  entrypoint: bash
  args:
    - -c
    - |
      tar czf nm.tar.gz ./node_modules
      tar czf dist.tar.gz ./dist
# step 3 Upload cache to Cloud Storage.
- id: "Upload"
  name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args: ['gsutil', 'cp', '*.tar.gz', 'gs://cache-psnext-v1-$BRANCH_NAME/']
timeout: 3600s
